<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particle Simulation</title>
</head>
<body>
    <label for="sizeX">sizeX:</label>
    <input type="number" id="sizeX" value="1000">
    <br>
    <label for="sizeY">sizeY:</label>
    <input type="number" id="sizeY" value="1000">
    <br>
    <label for="dt">dt:</label>
    <input type="number" id="dt" value="0.006">
    <br>
    <label for="friction">friction:</label>
    <input type="number" id="friction" value="0.01">
    <br>
    <label for="particleVisSize">particleVisSize:</label>
    <input type="number" id="particleVisSize" value="3">
    <br>
    <label for="n">n:</label>
    <input type="number" id="n" value="1000">
    <br>
    <label for="m">m:</label>
    <input type="number" id="m" value="6">
    <br>
    <label for="maxDistance">maxDistance:</label>
    <input type="number" id="maxDistance" value="100">
    <br>
    <label for="minDistance">minDistance:</label>
    <input type="number" id="minDistance" value="15">
    <br>
    <label for="universalRepulsiveForce">universalRepulsiveForce:</label>
    <input type="number" id="universalRepulsiveForce" value="100">
    <br>
    <label for="maxVelocity">maxVelocity:</label>
    <input type="number" id="maxVelocity" value="100">
    <br>

    <canvas id="particleCanvas" style="border:1px solid #000;"></canvas>
    <canvas id="forceMatrixCanvas" width="400" height="400" style="border:1px solid #000;"></canvas>
    <button onclick="particleReset()">Reset Particles</button>
    <button onclick="matrixRandom()">Randomize Matrix</button>
    <button onclick="matrixZero()">Zero Matrix</button>

    <script>
        class ParticleInfo {
            constructor(famIdx, x, y, vx, vy) {
                this.famIdx = famIdx;
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
            }
        }

        let sizeX, sizeY, dt, friction, particleVisSize, n, m, maxDistance, minDistance, universalRepulsiveForce;
        let particles = [];
        let forceMatrix = [];
        let particleCanvas, particleCtx, forceMatrixCanvas, forceMatrixCtx;

        function initializeVariables() {
            sizeX = parseFloat(document.getElementById("sizeX").value);
            sizeY = parseFloat(document.getElementById("sizeY").value);
            dt = parseFloat(document.getElementById("dt").value);
            friction = parseFloat(document.getElementById("friction").value);
            particleVisSize = parseFloat(document.getElementById("particleVisSize").value);
            n = parseInt(document.getElementById("n").value);
            m = parseInt(document.getElementById("m").value);
            maxDistance = parseFloat(document.getElementById("maxDistance").value);
            minDistance = parseFloat(document.getElementById("minDistance").value);
            universalRepulsiveForce = parseFloat(document.getElementById("universalRepulsiveForce").value);
            maxVelocity = parseFloat(document.getElementById("maxVelocity").value);

            // initializeForceMatrix(true);
        }

        function initializeForceMatrix(assignRand, setVal = 0) {
            forceMatrix = Array.from({ length: m }, () => Array(m).fill(0));

            if (assignRand) {
                forceMatrix = forceMatrix.map(row => row.map(() => Math.floor(Math.random() * 21 - 10) / 10));
            }else{
                forceMatrix.forEach(row => row.fill(setVal));
            }
        }

        function updateParticles() {
            for (let i = 0; i < particles.length; i++) {
                let a = particles[i];

                // a.x += a.vx * dt;
                // a.y += a.vy * dt;
                a.x = (a.x + a.vx * dt + sizeX) % sizeX;
                a.y = (a.y + a.vy * dt + sizeY) % sizeY;

                a.vx *= friction;
                a.vy *= friction;
            }
        }

        function rule() {
            for (let i = 0; i < n; i++) {
                let fx = 0;
                let fy = 0;
                let a = particles[i];

                for (let j = 0; j < n; j++) {
                    let b = particles[j];

                    if (b !== a) {
                        let dx = a.x - b.x;
                        let dy = a.y - b.y;

                        // dx = (dx + sizeX / 2) % sizeX - sizeX / 2;
                        // dy = (dy + sizeY / 2) % sizeY - sizeY / 2;

                        if (Math.abs(dx) > sizeX / 2) {
                            dx -= Math.sign(dx) * sizeX;
                        }
                        if (Math.abs(dy) > sizeY / 2) {
                            dy -= Math.sign(dy) * sizeY;
                        }

                        let attraction = forceMatrix[a.famIdx][b.famIdx] * 100;
                        let d = Math.sqrt(dx ** 2 + dy ** 2);

                        let currentForce = 0; 

                        if (d <= maxDistance && d >= minDistance) {
                            let t = (d - minDistance) / (maxDistance - minDistance);
                            currentForce = (1 - Math.abs(t - 0.5) * 2) * attraction;
                        } else if (d > maxDistance) {
                            currentForce = 0;
                        } else if (d < minDistance) {
                            let t = minDistance / d;
                            currentForce = t * universalRepulsiveForce;
                        }

                        if (d === 0) {
                            console.error("Distance is equal to Zero!");
                        }

                        fx += dx / d * currentForce;
                        fy += dy / d * currentForce;
                    }
                }

                fx *= maxDistance;
                fy *= maxDistance;

                a.vx += fx * dt;
                a.vy += fy * dt;

                a.vx = Math.min(Math.max(a.vx, -maxVelocity), maxVelocity);
                a.vy = Math.min(Math.max(a.vy, -maxVelocity), maxVelocity);
            }
        }

        function generateParticles(amount) {
            let particleList = [];

            for (let i = 0; i < amount; i++) {
                let xPos = Math.random() * sizeX;
                let yPos = Math.random() * sizeY;
                let idx = Math.floor(Math.random() * m);

                let particle = new ParticleInfo(idx, xPos, yPos, 0, 0);
                particleList.push(particle);
            }

            return particleList;
        }

        function particleReset() {
            initializeVariables();
            particles = generateParticles(n);
        }

        function matrixRandom() {
            initializeVariables();
            initializeForceMatrix(true);
        }

        function matrixZero() {
            initializeVariables();
            initializeForceMatrix(false);
        }

        function drawForceMatrix() {
            forceMatrixCtx.clearRect(0, 0, forceMatrixCanvas.width, forceMatrixCanvas.height);

            for (let i = 0; i < m; i++) {
                forceMatrixCtx.fillStyle = `hsl(${(i / m) * 360}, 100%, 50%)`;
                forceMatrixCtx.fillRect(i * (forceMatrixCanvas.width / m), 0, forceMatrixCanvas.width / m, 20);
            }

            for (let j = 0; j < m; j++) {
                forceMatrixCtx.fillStyle = `hsl(${(j / m) * 360}, 100%, 50%)`;
                forceMatrixCtx.fillRect(0, j * (forceMatrixCanvas.height / m), 20, forceMatrixCanvas.height / m);
            }

            for (let i = 0; i < m; i++) {
                for (let j = 0; j < m; j++) {
                    forceMatrixCtx.fillStyle = 'black';
                    let text = forceMatrix[i][j].toFixed(2);
                    let x = i * (forceMatrixCanvas.width / m) + 5 + (forceMatrixCanvas.width / m - 30) / 2; 
                    let y = j * (forceMatrixCanvas.height / m) + 15 + (forceMatrixCanvas.height / m - 20) / 2; 
                    forceMatrixCtx.fillText(text, x, y);
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            initializeVariables();
            initializeForceMatrix(true);
            particles = generateParticles(n);

            particleCanvas = document.getElementById("particleCanvas");
            particleCanvas.width = sizeX;
            particleCanvas.height = sizeY;
            particleCtx = particleCanvas.getContext("2d");
            // particleCanvas.style.backgroundColor = 'black';

            forceMatrixCanvas = document.getElementById("forceMatrixCanvas");
            forceMatrixCtx = forceMatrixCanvas.getContext("2d");

            function updateVisualization() {
                particleCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
                updateParticles();
                rule();
                for (let i = 0; i < particles.length; i++) {
                    let particle = particles[i];
                    particleCtx.beginPath();
                    particleCtx.arc(particle.x, particle.y, particleVisSize, 0, 2 * Math.PI);
                    particleCtx.fillStyle = `hsl(${(particle.famIdx / m) * 360}, 100%, 50%)`;
                    particleCtx.fill();
                    // particleCtx.stroke();
                }
                drawForceMatrix();

                requestAnimationFrame(updateVisualization);
            }

            updateVisualization();

            // Listen for changes in input fields and update the simulation
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function () {

                    let prevN = n;
                    let prevM = m;
 
                    initializeVariables();

                    if (prevN !== n || prevM !== m) {
                        initializeForceMatrix(true);
                        particles = generateParticles(n);
                    }

                    particleCanvas.width = sizeX;
                    particleCanvas.height = sizeY;
                });
            });
            
            // Mouse click event to set forceMatrix values to 0
            forceMatrixCanvas.addEventListener('mousedown', function (event) {
                if (event.button === 1) { // 1 represents the middle mouse button
                    let mouseX = event.clientX - forceMatrixCanvas.getBoundingClientRect().left;
                    let mouseY = event.clientY - forceMatrixCanvas.getBoundingClientRect().top;

                    let i = Math.floor((mouseX / forceMatrixCanvas.width) * m);
                    let j = Math.floor((mouseY / forceMatrixCanvas.height) * m);

                    if (i >= 0 && i < m && j >= 0 && j < m) {
                        forceMatrix[i][j] = 0;
                        drawForceMatrix();
                    }
                }
            });

            // Mousewheel event to edit forceMatrix values
            forceMatrixCanvas.addEventListener('wheel', function (event) {
                let mouseX = event.clientX - forceMatrixCanvas.getBoundingClientRect().left;
                let mouseY = event.clientY - forceMatrixCanvas.getBoundingClientRect().top;

                let i = Math.floor((mouseX / forceMatrixCanvas.width) * m);
                let j = Math.floor((mouseY / forceMatrixCanvas.height) * m);

                if (i >= 0 && i < m && j >= 0 && j < m) {
                    let matrixUpdate = event.deltaY * -0.001;

                    forceMatrix[i][j] = Math.min(Math.max(forceMatrix[i][j] += matrixUpdate, -1), 1);
                    drawForceMatrix();
                }

                event.preventDefault();
            });
        });
    </script>
</body>
</html>
